name: Release Android - Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version: patch | minor | major'
        required: true
      release:
        description: 'Release type alpha | beta | prod'
        required: true

env:
  USER_EMAIL: ${{ secrets.USER_EMAIL }}
  USER_NAME: ${{ secrets.USER_NAME }}
  KEYSTORE_KEY_ALIAS: ${{ secrets.KEYSTORE_KEY_ALIAS }}
  KEYSTORE_KEY_PASSWORD: ${{ secrets.KEYSTORE_KEY_PASSWORD }}
  KEYSTORE_STORE_PASSWORD: ${{ secrets.KEYSTORE_STORE_PASSWORD }}
  ANDROID_KEYSTORE_FILE: ${{ secrets.ANDROID_KEYSTORE_FILE }}
  PLAY_CONFIG_JSON: ${{ secrets.PLAY_CONFIG_JSON }}

jobs:
  version-bump:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@master

      - name: Version bump and tagging
        run: |
          npm ci
          npm version ${{ github.event.inputs.version }}

  android-prod-publish:
    needs: version-bump
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@master

      - name: Cache Gradle
        uses: actions/cache@v1
        with:
          path: ~/.gradle/caches/
          key: cache-clean-gradle-${{ matrix.os }}-${{ matrix.jdk }}

      - name: Cache Gradle Wrapper
        uses: actions/cache@v1
        with:
          path: ~/.gradle/wrapper/
          key: cache-clean-wrapper-${{ matrix.os }}-${{ matrix.jdk }}

      - name: Grant Permission to Execute
        run: chmod +x android/gradlew

      - name: Configure Keystore
        run: |
          echo "$ANDROID_KEYSTORE_FILE" > release.keystore.jks.b64
          base64 -d -i release.keystore.jks.b64 > app/release.keystore.jks
        working-directory: android

      - name: Build bundle android
        run: npm run bundle-android-prod

      - name: Create Google Play Config file
        run: |
          echo "$PLAY_CONFIG_JSON" > play_config.json.b64
          base64 -d -i play_config.json.b64 > play_config.json
        working-directory: android

      - name: Validate Google Play Store json_key works
        run: fastlane run validate_play_store_json_key json_key:play_config.json
        working-directory: android

      - name: Distribute app to alpha  ðŸš€
        run: |
          EXTRACTED_VERSION=$(awk -F \" '/"version": ".+"/ { print $4; exit; }' ../package.json)
          export VERSION_CODE=${{ github.run_number }}
          export VERSION_NAME="$EXTRACTED_VERSION-${{ github.run_number }}"
          fastlane ${{ github.event.inputs.release }}
        working-directory: android
